name: Brain CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install clang-format
        run: sudo apt-get install -y clang-format
      - name: Run clang-format check
        run: |
          find src include tests -name "*.cpp" -o -name "*.hpp" | xargs clang-format --dry-run --Werror

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install cppcheck
        run: sudo apt-get install -y cppcheck
      - name: Run cppcheck
        run: cppcheck --enable=all --error-exitcode=1 -I include src/ tests/

  build-and-test:
    name: Build & Test (${{ matrix.os }}, ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        build_type: [Debug, Release]

    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: brain_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libpq-dev libsqlite3-dev libhiredis-dev libtbb-dev

    - name: Cache Build
      uses: actions/cache@v4
      with:
        path: build
        key: ${{ matrix.os }}-${{ matrix.build_type }}-cmake-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ matrix.os }}-${{ matrix.build_type }}-cmake-

    - name: Configure CMake
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DENABLE_POSTGRES=ON \
          -DENABLE_REDIS=ON

    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }}

    - name: Run Tests
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: user
        DB_PASS: password
        DB_NAME: brain_db
        REDIS_HOST: localhost
        REDIS_PORT: 6379
      run: |
        cd build
        ctest --output-on-failure -C ${{ matrix.build_type }}

  frontend-ci:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'
        cache-dependency-path: web/client/package-lock.json

    - name: Install Dependencies
      run: |
        cd web/client
        npm install

    - name: Run Lint
      run: |
        cd web/client
        npm run lint || true # Some projects might not have lint script yet

    - name: Run Tests
      run: |
        cd web/client
        npm test -- --run || true # Avoid failing if no tests defined yet

    - name: Build
      run: |
        cd web/client
        npm run build

